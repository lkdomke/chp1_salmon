---
title: "EDA_salmon_data"
author: "Lia Domke"
date: "10/7/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Libraries
```{r libraries, echo = FALSE}
library(tidyverse)
library(corrgram)
library(MASS)
library(pscl)
library(visreg)
library(readxl)
library(lubridate)
library(mgcv)
library(reshape2)
library(cowplot)
library(lmtest)
```

# Data Entry
This file is based on the "DataCleaning_Seine_2019" R Markdown script. Extracted relevant salmon abundances (with zeros where we seined but caught no salmon), environmental information (from YSI meter), habitat information (i.e. shoot/flowering shoot density/m2), and otter density by site. 

allsites - includes distance to anadramous stream for all noaa sites and 17/19 sites. 
```{r, echo = FALSE}
dat <- read.csv("Data/FISH604_combined_10-5-19.csv", stringsAsFactors = FALSE, header = TRUE)

allsites <- read_xls("../APECS Master repository/APECS Master repo/ALL_DATA/Lia_fish/dist2_anad_allsites_102319.xls", sheet = 1) # not on KNB

biom <- read.csv("../APECS Master repository/APECS Master repo/ALL_DATA/seagrass_biomass_conversions.csv",
                 stringsAsFactors = FALSE, header = TRUE) # not on KNB

eel17 <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/urn%3Auuid%3Ac79aa46e-5e20-4559-86e5-64166af2cf94", method = "libcurl"),stringsAsFactors = FALSE, header = TRUE)

env17 <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/urn%3Auuid%3A5e946e41-4f5f-4499-9969-766f01113971", method = "libcurl"), stringsAsFactors = FALSE, header = TRUE)

name <- read.csv("Data/site_code_names.csv", stringsAsFactors = FALSE, header = TRUE) # updated location 9/20
```
# Data Clean up
## Main data frame
NOTE!! removed Julian day > 180 filter
```{r}
# Take a look at data
glimpse(dat)

# do some minor clean up 
dat <- dat[-42,-1] # removes first column and second calder bay survey (didn't happen)
dat$year <- as.factor(dat$year)
dat[,25:29] <- data.frame(lapply(dat[,25:29], as.numeric), stringsAsFactors = FALSE) # make sure salmon abundance is numeric
dat1 <- dat %>%
  rowwise() %>%
  mutate(abundance = sum(SALCHIN, SALCHUM, SALCOHO, SALPINK, SALSOCK))

```

## Distance from anad stream
allsites needs to be combined with environmental information about the sites
```{r}
str(allsites)
# 2017 2019 sites information is at the bottom
dist <- allsites[616:661,-c(1:2,4:6,11)] # this is the straightline distance to nearest stream

dist17 <- dist %>%
  filter(habitat == "eelgrass", year == "2017")%>%
  rename(site = site_event) 

dist19 <- dist %>%
  filter(habitat == "eelgrass", year == "2019")%>%
  rename(site = site_event) 

names1 <- name %>%
  dplyr::select(site, site_code)
names1 <- names1[-c(22:30),]
names1 <- data.frame(lapply(names1, as.character), stringsAsFactors = FALSE)
colnames(names1) <- c("place", "site") # make sure what you are joining has the same column name
dist17.2 <- left_join(dist17, names1, by = "site") %>% # join by site
  dplyr::select(-site) %>%  # remove site code column
  rename(site = place) # rename site name

# slight changes to names on dist19
levels(as.factor(dist19$site))
dist19$site <- as.factor(dist19$site)
levels(dist19$site)[levels(dist19$site)=="Naukati"] <- "Naukati Bay"
levels(dist19$site)[levels(dist19$site)=="South Wadleigh"] <- "South Wadleigh Island"
levels(dist19$site)[levels(dist19$site)=="Chusini"] <- "Chusini Cove"
levels(dist19$site)[levels(dist19$site)=="Goats mouth Inlet"] <- "Goats mouth inlet"
levels(dist19$site)[levels(dist19$site)=="Kaguk Bay"] <- "Kaguk Cove"

dist_comb <-rbind(dist19, dist17.2)
dist_all <- dist_comb %>%
  mutate(dist_anad_km = NEAR_DIST/100) %>%
  dplyr::select(-NEAR_DIST)

# combine with total data
dist_all$year <- as.factor(dist_all$year)

dat3 <- left_join(dat1, dist_all)
```

## Seagrass biomass
```{r}
str(biom) 
# 2019
# convert biomass to g/m2 for both shoots and flowering shoots
# note: flowering shoot estimation is likely an underestimation because 
# flowering biomass is more (because they're taller) than normal shoots. 
biom_site <- biom %>%
  mutate(shoot_biomass_gm2 = (avg_biomass * density_m2)) %>% 
  mutate(flowering_biomass_gm2 = (avg_biomass * flowering_m2)) %>%
  mutate(total_biomass_gm2 = (flowering_biomass_gm2 + shoot_biomass_gm2)) %>%
  group_by(site) %>%
  summarise(avg_biom_site_gm2 = mean(total_biomass_gm2)) %>%
  mutate(year = "2019")

# 2017
str(eel17)

biom17 <- eel17 %>%
  mutate(shoot_dw = shoot_foil_dw - shoot_foil, na.rm = T) %>%
  group_by(site, quadrat) %>%
  summarise(avg_shoot_dw = mean(shoot_dw))


eel_hab17 <- env17 %>%
  mutate(year = "2017") %>%
  mutate(date = ymd(YYYYMMDD)) %>%
  mutate(date_julian = yday(date)) %>%
  mutate(eelgrass_shoots_msq = eelgrass_shoots_0.25msq * 4) %>%
  mutate(flowering_shoots_msq = flowering_shoots_0.25msq * 4) %>%
  dplyr::select(quadrat, site, date, year, date_julian,
         eelgrass_shoots_msq,flowering_shoots_msq) %>%
  na.omit()

df <- left_join(eel_hab17, biom17) %>%
  mutate(total_shoot_m2 = (eelgrass_shoots_msq + flowering_shoots_msq)) %>%
  mutate(total_biomass_gm2 = total_shoot_m2 * avg_shoot_dw, na.rm = T) %>%
  group_by(site) %>%
  summarise(avg_biom_site_gm2 = mean(total_biomass_gm2, na.rm = T))

# change site names in 2017 for df 
names1 <- name %>%
  dplyr::select(site, site_code)
names1 <- names1[-c(22:30),]
names1 <- data.frame(lapply(names1, as.character), stringsAsFactors = FALSE)
colnames(names1) <- c("place", "site") # make sure what you are joining has the same column name
df2 <- left_join(df, names1, by = "site") # join by site

df3 <- df2 %>%
  dplyr::select(-site) %>%  # remove site code column
  rename(site = place) %>% # rename site name
  mutate(year = "2017")

# Combine 2017 and 2019 biomass, with e/ other and then the main df (dat)
biom_all <- rbind(df3, biom_site)
biom_all$year <- as.factor(biom_all$year)

dat4 <- left_join(dat3, biom_all, by = c("site", "year"))

#write.csv(dat4, "Data/salmon_env_1719.csv")
```

## Qualitative sediment
Want to be able to account for differences in sediment at seagrass sites for data exploration purposes/analysis
```{r}

```

Analysis has been moved to new rmarkdown file: Salmon_env_analysis_pow.Rmd